<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>JF Resolve</title>
    </head>
    <body>
        <div
            id="JfresolveConfigPage"
            data-role="page"
            class="page type-interior pluginConfigurationPage"
            data-require="emby-input,emby-button"
        >
            <div data-role="content">
                <div class="content-primary">
                    <form id="JfresolveConfigForm">
                        <!-- TMDb API Key -->
                        <div class="inputContainer">
                            <label
                                class="inputLabel inputLabelUnfocused"
                                for="TmdbApiKey"
                                >TMDb API Key</label
                            >
                            <input
                                id="TmdbApiKey"
                                name="TmdbApiKey"
                                type="text"
                                is="emby-input"
                            />
                            <div class="fieldDescription">
                                Your personal TMDb API key is required to search
                                for movies and TV shows. Without this, the
                                plugin cannot function. Get one free at
                                <a
                                    href="https://www.themoviedb.org/settings/api"
                                    target="_blank"
                                    >themoviedb.org/settings/api</a
                                >
                            </div>
                        </div>

                        <div class="inputContainer">
                            <label
                                class="inputLabel inputLabelUnfocused"
                                for="SearchNumber"
                                >Search Results</label
                            >
                            <input
                                id="SearchNumber"
                                name="SearchNumber"
                                type="number"
                                min="1"
                                max="20"
                                is="emby-input"
                            />
                            <div class="fieldDescription">
                                Maximum number of search results to show for
                                each search.
                            </div>
                        </div>

                        <div class="checkboxContainer">
                            <label>
                                <input
                                    type="checkbox"
                                    id="EnableExternalResults"
                                    is="emby-checkbox"
                                />
                                <span>Enable External Search Results</span>
                            </label>
                        </div>
                        <div class="checkboxContainer">
                            <label>
                                <input
                                    type="checkbox"
                                    id="EnableMixed"
                                    is="emby-checkbox"
                                />
                                <span
                                    >Show Local Files With External Alternatives
                                    (Mixed)</span
                                >
                            </label>
                        </div>
                        <div class="fieldDescription">
                            Default to local library if the media already
                            exists. If not, then show external alternatives.
                        </div>

                        <div class="inputContainer">
                            <label
                                class="inputLabel inputLabelUnfocused"
                                for="JellyfinBaseUrl"
                                >Jellyfin Base URL</label
                            >
                            <input
                                id="JellyfinBaseUrl"
                                name="JellyfinBaseUrl"
                                type="text"
                                is="emby-input"
                            />
                            <div class="fieldDescription">
                                Examples:
                                <code>http://192.168.1.100:8096</code>, or
                                <code>https://my-jellyfin.example.com</code>.
                                Include http or https depending on protocol.
                            </div>
                        </div>

                        <div class="inputContainer">
                            <label
                                class="inputLabel inputLabelUnfocused"
                                for="AddonManifestUrl"
                                >Addon Link (Manifest JSON URL)</label
                            >
                            <input
                                id="AddonManifestUrl"
                                name="AddonManifestUrl"
                                type="text"
                                is="emby-input"
                            />
                            <div class="fieldDescription">
                                URL to your addon's manifest.json file. Example:
                                <code
                                    >stremio://torrentio.strem.fun/manifest.json</code
                                >
                                Required for streams to work. Only stremio
                                streaming addons with Debrid are supported.
                            </div>
                        </div>

                        <div class="checkboxContainer">
                            <label>
                                <input
                                    type="checkbox"
                                    id="IncludeAdult"
                                    is="emby-checkbox"
                                />
                                <span>Include Adult Content</span>
                            </label>
                        </div>

                        <div class="checkboxContainer">
                            <label>
                                <input
                                    type="checkbox"
                                    id="IncludeUnreleased"
                                    is="emby-checkbox"
                                />
                                <span>Include Unreleased Titles</span>
                            </label>
                        </div>

                        <div class="inputContainer">
                            <label
                                class="inputLabel inputLabelUnfocused"
                                for="UnreleasedBufferDays"
                                >Release Buffer Days</label
                            >
                            <input
                                id="UnreleasedBufferDays"
                                name="UnreleasedBufferDays"
                                type="number"
                                min="0"
                                max="365"
                                is="emby-input"
                            />
                            <div class="fieldDescription">
                                Number of days to wait after a movie's official
                                release date before showing it.
                            </div>
                        </div>

                        <div class="checkboxContainer">
                            <label>
                                <input
                                    type="checkbox"
                                    id="IncludeSpecials"
                                    is="emby-checkbox"
                                />
                                <span>Include Specials (Season 0)</span>
                            </label>
                        </div>

                        <hr />
                        <h3>Library Paths</h3>

                        <!-- Movies -->
                        <div class="inputContainer">
                            <label
                                class="inputLabel inputLabelUnfocused"
                                for="MoviesLibraryPath"
                                >Movies Library Path</label
                            >
                            <input
                                id="MoviesLibraryPath"
                                name="MoviesLibraryPath"
                                type="text"
                                is="emby-input"
                            />
                            <div class="fieldDescription">
                                Location where movies are. This should be a
                                folder that's already added as a library in
                                Jellyfin. Example:
                                <code>/mnt/media/movies</code> or
                                <code>C:\Videos\Movies</code>. At least one path
                                is required for library population to work.
                            </div>
                        </div>

                        <!-- TV Shows -->
                        <div class="inputContainer">
                            <label
                                class="inputLabel inputLabelUnfocused"
                                for="ShowsLibraryPath"
                                >TV Shows Library Path</label
                            >
                            <input
                                id="ShowsLibraryPath"
                                name="ShowsLibraryPath"
                                type="text"
                                is="emby-input"
                            />
                        </div>

                        <!-- Anime (optional) -->
                        <div class="inputContainer">
                            <label
                                class="inputLabel inputLabelUnfocused"
                                for="AnimeLibraryPath"
                                >Anime Library Path (Optional)</label
                            >
                            <input
                                id="AnimeLibraryPath"
                                name="AnimeLibraryPath"
                                type="text"
                                is="emby-input"
                            />
                            <div class="fieldDescription">
                                Optional. If set, anime titles will be populated
                                here instead of the regular TV shows folder.
                                Leave empty to disable. If enabled, it must be a
                                mixed library for movies and shows in Jellyfin.
                            </div>
                        </div>

                        <!-- Populate Library Button -->
                        <div
                            class="inputContainer"
                            style="
                                margin-top: 20px;
                                padding-top: 20px;
                                border-top: 1px solid #333;
                            "
                        >
                            <label class="inputLabel">Library Population</label>
                            <div
                                class="fieldDescription"
                                style="margin-bottom: 15px"
                            >
                                Enable automatic library population. Plugin
                                automatically fetches popular content from tmdb
                                at 03:00AM UTC
                            </div>
                            <div class="checkboxContainer">
                                <label>
                                    <input
                                        type="checkbox"
                                        id="EnableLibraryPopulation"
                                        is="emby-checkbox"
                                    />
                                    <span>Enable Library Population</span>
                                </label>
                            </div>

                            <div class="inputContainer">
                                <label
                                    class="inputLabel inputLabelUnfocused"
                                    for="LibraryPopulationHour"
                                    >Library Population Time (UTC)</label
                                >
                                <input
                                    id="LibraryPopulationHour"
                                    name="LibraryPopulationHour"
                                    type="number"
                                    min="0"
                                    max="23"
                                    is="emby-input"
                                />
                                <div class="fieldDescription">
                                    Hour of the day (0-23) in UTC when library
                                    population should run automatically. For
                                    example, 3 means 3:00 AM UTC, 15 means 3:00
                                    PM UTC.
                                </div>
                            </div>

                            <div class="inputContainer">
                                <label
                                    class="inputLabel inputLabelUnfocused"
                                    for="ItemsPerRequest"
                                    >Items Per Request</label
                                >
                                <input
                                    id="ItemsPerRequest"
                                    name="ItemsPerRequest"
                                    type="number"
                                    min="1"
                                    max="1000"
                                    is="emby-input"
                                />
                                <div class="fieldDescription">
                                    How many items to fetch daily in each batch
                                    during library population.
                                </div>
                            </div>

                            <div class="checkboxContainer">
                                <label>
                                    <input
                                        type="checkbox"
                                        id="EnableAutoScanAfterPopulation"
                                        is="emby-checkbox"
                                    />
                                    <span>Auto Scan After Population</span>
                                </label>
                            </div>
                            <div class="fieldDescription">
                                When enabled, Jellyfin will scan the library
                                folders after population to immediately discover
                                newly created STRM files. Disable this on slower
                                devices to avoid I/O overhead. Files will be
                                discovered on the next scheduled library scan if
                                disabled.
                            </div>

                            <button
                                id="PopulateLibraryBtn"
                                type="button"
                                is="emby-button"
                                class="raised button-submit block emby-button"
                            >
                                <span>Populate Library Now</span>
                            </button>
                            <div class="fieldDescription">
                                Click to manually start library population
                                immediately.
                            </div>
                        </div>

                        <hr />
                        <h3>Playback Tuning</h3>

                        <div class="checkboxContainer">
                            <label>
                                <input
                                    type="checkbox"
                                    id="EnableFFmpegCustomization"
                                    is="emby-checkbox"
                                />
                                <span>Enable FFmpeg Customization</span>
                            </label>
                        </div>
                        <div class="fieldDescription">
                            Enable custom FFmpeg settings for better remote
                            stream detection. Disable this to use Jellyfin's
                            default FFmpeg configuration.
                        </div>

                        <div id="FFmpegSettings" style="margin-top: 15px">
                            <div class="inputContainer">
                                <label
                                    class="inputLabel inputLabelUnfocused"
                                    for="FFmpegProbeSize"
                                    >FFmpeg Probe Size</label
                                >
                                <input
                                    id="FFmpegProbeSize"
                                    name="FFmpegProbeSize"
                                    type="text"
                                    is="emby-input"
                                />
                                <div class="fieldDescription">
                                    Maximum bytes to read for format detection
                                    (e.g., 40M). Increase for slow remote
                                    streams.
                                </div>
                            </div>
                            <div class="inputContainer">
                                <label
                                    class="inputLabel inputLabelUnfocused"
                                    for="FFmpegAnalyzeDuration"
                                    >FFmpeg Analyze Duration</label
                                >
                                <input
                                    id="FFmpegAnalyzeDuration"
                                    name="FFmpegAnalyzeDuration"
                                    type="text"
                                    is="emby-input"
                                />
                                <div class="fieldDescription">
                                    Maximum time to analyze stream format (e.g.,
                                    5M). Increase if streams timeout during
                                    detection.
                                </div>
                            </div>
                        </div>

                        <div>
                            <button
                                is="emby-button"
                                type="submit"
                                class="raised button-submit block emby-button"
                            >
                                <span>Save</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <script type="text/javascript">
                var JfresolveConfig = {
                    pluginUniqueId: "506F18B8-5DAD-4CD3-B9A0-F7ED933E9939",
                    updateFFmpegVisibility: function () {
                        var isEnabled = document.querySelector(
                            "#EnableFFmpegCustomization",
                        ).checked;
                        var ffmpegSettings =
                            document.querySelector("#FFmpegSettings");
                        ffmpegSettings.style.display = isEnabled
                            ? "block"
                            : "none";
                    },
                };

                // Load plugin config into form
                document
                    .querySelector("#JfresolveConfigPage")
                    .addEventListener("pageshow", function () {
                        Dashboard.showLoadingMsg();
                        ApiClient.getPluginConfiguration(
                            JfresolveConfig.pluginUniqueId,
                        ).then(function (config) {
                            document.querySelector("#TmdbApiKey").value =
                                config.TmdbApiKey || "";
                            document.querySelector("#MoviesLibraryPath").value =
                                config.MoviesLibraryPath || "";
                            document.querySelector("#ShowsLibraryPath").value =
                                config.ShowsLibraryPath || "";
                            document.querySelector("#AnimeLibraryPath").value =
                                config.AnimeLibraryPath || "";
                            document.querySelector("#JellyfinBaseUrl").value =
                                config.JellyfinBaseUrl || "";
                            document.querySelector("#AddonManifestUrl").value =
                                config.AddonManifestUrl || "";
                            document.querySelector("#IncludeAdult").checked =
                                config.IncludeAdult || false;
                            document.querySelector(
                                "#IncludeUnreleased",
                            ).checked = config.IncludeUnreleased || false;
                            document.querySelector("#IncludeSpecials").checked =
                                config.IncludeSpecials || false;
                            document.querySelector("#SearchNumber").value =
                                config.SearchNumber || 3;
                            document.querySelector(
                                "#EnableExternalResults",
                            ).checked = config.EnableExternalResults || false;
                            document.querySelector("#EnableMixed").checked =
                                config.EnableMixed || false;
                            document.querySelector(
                                "#UnreleasedBufferDays",
                            ).value =
                                config.UnreleasedBufferDays !== null &&
                                config.UnreleasedBufferDays !== undefined
                                    ? config.UnreleasedBufferDays
                                    : 30;
                            document.querySelector(
                                "#EnableLibraryPopulation",
                            ).checked = config.EnableLibraryPopulation || false;
                            document.querySelector(
                                "#LibraryPopulationHour",
                            ).value =
                                config.LibraryPopulationHour != null
                                    ? config.LibraryPopulationHour
                                    : 3;
                            document.querySelector("#ItemsPerRequest").value =
                                config.ItemsPerRequest != null
                                    ? config.ItemsPerRequest
                                    : 100;
                            document.querySelector(
                                "#EnableAutoScanAfterPopulation",
                            ).checked =
                                config.EnableAutoScanAfterPopulation || false;
                            document.querySelector(
                                "#EnableFFmpegCustomization",
                            ).checked =
                                config.EnableFFmpegCustomization != null
                                    ? config.EnableFFmpegCustomization
                                    : true;
                            document.querySelector("#FFmpegProbeSize").value =
                                config.FFmpegProbeSize || "40M";
                            document.querySelector(
                                "#FFmpegAnalyzeDuration",
                            ).value = config.FFmpegAnalyzeDuration || "5M";

                            // Toggle FFmpeg settings visibility
                            JfresolveConfig.updateFFmpegVisibility();

                            Dashboard.hideLoadingMsg();
                        });
                    });

                // Toggle FFmpeg settings visibility based on checkbox
                document
                    .querySelector("#EnableFFmpegCustomization")
                    .addEventListener("change", function () {
                        JfresolveConfig.updateFFmpegVisibility();
                    });

                // Save plugin config from form
                document
                    .querySelector("#JfresolveConfigForm")
                    .addEventListener("submit", function (e) {
                        e.preventDefault();
                        Dashboard.showLoadingMsg();
                        ApiClient.getPluginConfiguration(
                            JfresolveConfig.pluginUniqueId,
                        ).then(function (config) {
                            config.TmdbApiKey =
                                document.querySelector("#TmdbApiKey").value;
                            config.MoviesLibraryPath =
                                document.querySelector(
                                    "#MoviesLibraryPath",
                                ).value;
                            config.ShowsLibraryPath =
                                document.querySelector(
                                    "#ShowsLibraryPath",
                                ).value;
                            config.AnimeLibraryPath =
                                document.querySelector(
                                    "#AnimeLibraryPath",
                                ).value;
                            config.JellyfinBaseUrl =
                                document
                                    .querySelector("#JellyfinBaseUrl")
                                    .value.trim() || "http://127.0.0.1:8096";
                            config.AddonManifestUrl =
                                document.querySelector(
                                    "#AddonManifestUrl",
                                ).value;
                            config.IncludeAdult =
                                document.querySelector("#IncludeAdult").checked;
                            config.IncludeUnreleased =
                                document.querySelector(
                                    "#IncludeUnreleased",
                                ).checked;
                            config.IncludeSpecials =
                                document.querySelector(
                                    "#IncludeSpecials",
                                ).checked;
                            config.SearchNumber =
                                parseInt(
                                    document.querySelector("#SearchNumber")
                                        .value,
                                    10,
                                ) || 3;
                            config.EnableExternalResults =
                                document.querySelector(
                                    "#EnableExternalResults",
                                ).checked;
                            config.EnableMixed =
                                document.querySelector("#EnableMixed").checked;
                            var parsedBufferDays = parseInt(
                                document.querySelector("#UnreleasedBufferDays")
                                    .value,
                                10,
                            );
                            config.UnreleasedBufferDays = !isNaN(
                                parsedBufferDays,
                            )
                                ? parsedBufferDays
                                : 30;
                            config.EnableLibraryPopulation =
                                document.querySelector(
                                    "#EnableLibraryPopulation",
                                ).checked;
                            var parsedHour = parseInt(
                                document.querySelector("#LibraryPopulationHour")
                                    .value,
                                10,
                            );
                            config.LibraryPopulationHour =
                                !isNaN(parsedHour) &&
                                parsedHour >= 0 &&
                                parsedHour <= 23
                                    ? parsedHour
                                    : 3;
                            config.ItemsPerRequest =
                                parseInt(
                                    document.querySelector("#ItemsPerRequest")
                                        .value,
                                    10,
                                ) || 100;
                            config.EnableAutoScanAfterPopulation =
                                document.querySelector(
                                    "#EnableAutoScanAfterPopulation",
                                ).checked;
                            config.EnableFFmpegCustomization =
                                document.querySelector(
                                    "#EnableFFmpegCustomization",
                                ).checked;
                            config.FFmpegProbeSize = (
                                document.querySelector("#FFmpegProbeSize")
                                    .value || "40M"
                            ).trim();
                            config.FFmpegAnalyzeDuration = (
                                document.querySelector("#FFmpegAnalyzeDuration")
                                    .value || "5M"
                            ).trim();
                            ApiClient.updatePluginConfiguration(
                                JfresolveConfig.pluginUniqueId,
                                config,
                            ).then(function (result) {
                                Dashboard.processPluginConfigurationUpdateResult(
                                    result,
                                );
                            });
                        });
                    });

                // Populate library button
                document
                    .querySelector("#PopulateLibraryBtn")
                    .addEventListener("click", function () {
                        Dashboard.showLoadingMsg();
                        ApiClient.ajax({
                            type: "POST",
                            url: ApiClient.getUrl(
                                "Plugins/Jfresolve/PopulateLibrary",
                            ),
                            dataType: "json",
                        })
                            .then(function () {
                                Dashboard.hideLoadingMsg();
                                Dashboard.alert(
                                    "Library population started successfully.",
                                );
                            })
                            .catch(function (error) {
                                Dashboard.hideLoadingMsg();
                                Dashboard.alert(
                                    "Error: " +
                                        (error.statusText || "Unknown error"),
                                );
                            });
                    });
            </script>
        </div>
    </body>
</html>
